# راهنمای راه‌اندازی سرویس Metrics (Zabbix)

## مشکل
داده‌های Zabbix در بخش دوم جداول داشبورد d8 نمایش داده نمی‌شوند.

## علت
سرویس Metrics که داده‌های Zabbix را از API دریافت می‌کند، باید در پورت 6000 در حال اجرا باشد.

## راه‌حل

### 1. راه‌اندازی سرویس Metrics

#### روش 1: استفاده از اسکریپت PowerShell
```powershell
.\start-metrics-service.ps1
```

#### روش 2: راه‌اندازی دستی
```powershell
cd app
python zabbix2.py
```

سرویس باید روی پورت 6000 اجرا شود و پیام زیر را نمایش دهد:
```
 * Running on http://0.0.0.0:6000
```

### 2. بررسی اجرای سرویس

برای بررسی اینکه سرویس در حال اجرا است یا نه:
```powershell
# بررسی پورت 6000
netstat -ano | findstr :6000
```

یا تست مستقیم:
```powershell
# تست سرویس با یک hostname
curl http://localhost:6000/metrics?host=lms1
```

### 3. بررسی لاگ‌ها

اگر سرویس در حال اجرا است اما داده نمایش داده نمی‌شود، لاگ‌های برنامه را بررسی کنید:
- فایل `logs/error.log` را بررسی کنید
- به دنبال پیام‌های warning یا error درباره Zabbix باشید

### 4. بررسی Hostname ها

اطمینان حاصل کنید که hostname های استفاده شده در Zabbix با hostname های تعریف شده در کد مطابقت دارند:

**Hostname های تعریف شده:**
- Zone1: `lms1`
- Zone2: `lms2`
- Zone3: `lms3`
- Zone4: `lms4`
- Zone5: `lms5`
- Zone6: `lms6`
- Zone7: `lms7`
- Zone8: `lms8`
- Zone9: `lms9`
- Zone10: `lms10`
- Zone11: `meeting`

**نکته:** این hostname ها باید دقیقاً در Zabbix با همین نام‌ها تعریف شده باشند.

### 5. تنظیمات Zabbix

اطمینان حاصل کنید که:
- Zabbix API در دسترس است: `https://monitor.cfu.ac.ir`
- نام کاربری و رمز عبور درست هستند (در فایل `app/zabbix2.py`)
- Hostname ها در Zabbix با نام‌های بالا مطابقت دارند

### 6. راه‌اندازی خودکار (اختیاری)

برای راه‌اندازی خودکار سرویس metrics در هنگام راه‌اندازی سیستم، می‌توانید آن را به اسکریپت `start-all-services.ps1` اضافه کنید.

## تغییرات انجام شده

1. **افزایش timeout:** از 2 ثانیه به 10 ثانیه افزایش یافت
2. **بهبود لاگ‌ها:** خطاها به صورت warning و info لاگ می‌شوند (نه فقط debug)
3. **مدیریت خطا:** خطاها به درستی handle می‌شوند و داده‌های خالی نمایش داده می‌شوند

## تست

بعد از راه‌اندازی سرویس، داشبورد d8 را رفرش کنید. داده‌های Zabbix باید در بخش دوم جداول نمایش داده شوند.

اگر هنوز داده نمایش داده نمی‌شود:
1. لاگ‌های برنامه را بررسی کنید
2. مطمئن شوید که سرویس metrics در حال اجرا است
3. hostname ها را در Zabbix بررسی کنید
