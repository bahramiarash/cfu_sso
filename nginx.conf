events {
    worker_connections 1024;
}

http {
    # Logging
    access_log logs/access.log;
    error_log logs/error.log;
    
    # Gzip compression for better performance
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    upstream auth_service {
        server localhost:5001;
    }

    upstream admin_service {
        server localhost:5002;
    }

    upstream survey_service {
        server localhost:5003;
    }

    upstream dashboard_service {
        server localhost:5004;
    }

    upstream kanban_service {
        server localhost:5005;
    }

    upstream gateway_service {
        server localhost:5000;
    }

    upstream monolithic_app {
        server localhost:5006;
    }

    # HTTP server (temporary - will redirect to HTTPS when SSL is enabled)
    # When SSL certificates are ready:
    # 1. Change listen 80 to listen 443 ssl http2
    # 2. Uncomment SSL certificate and configuration directives
    # 3. Add HTTP server block that redirects to HTTPS
    server {
        listen 80;
        # listen 443 ssl http2;  # Uncomment when SSL certificates are ready
        server_name bi.cfu.ac.ir;

    # SSL Certificate Configuration
    # IMPORTANT: Update these paths to your actual certificate files
    # For Windows: Use forward slashes or Windows path format
    # Example Windows: ssl_certificate C:/nginx/certs/cfu.ac.ir-cert.pem;
    # Example Linux: ssl_certificate /etc/nginx/certs/cfu.ac.ir-cert.pem;
    # For Let's Encrypt: ssl_certificate /etc/letsencrypt/live/bi.cfu.ac.ir/fullchain.pem;
    # 
    # NOTE: Uncomment these lines when you have SSL certificates ready
    # ssl_certificate C:/nginx/certs/cfu.ac.ir-cert.pem;
    # ssl_certificate_key C:/nginx/certs/private.pem;
    
    # SSL Configuration (uncomment when SSL certificates are ready)
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    # ssl_prefer_server_ciphers on;
    # ssl_session_cache shared:SSL:10m;
    # ssl_session_timeout 10m;
    # ssl_session_tickets off;
    
    # OCSP Stapling (requires resolver - uncomment if you have DNS resolver configured)
    # resolver 8.8.8.8 8.8.4.4 valid=300s;
    # resolver_timeout 5s;
    # ssl_stapling on;
    # ssl_stapling_verify on;
    
    # Security Headers
    # HSTS only works with HTTPS - uncomment when SSL is enabled
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Increase upload size limit
    client_max_body_size 50M;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;

    # Auth routes - remove /auth/ prefix before proxying
    location /auth/ {
        rewrite ^/auth/(.*)$ /$1 break;
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /auth;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Admin routes
    location /admin/ {
        proxy_pass http://admin_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Survey routes - proxy to Gateway Service (which proxies to monolithic app)
    location /survey {
        # Handle both /survey and /survey/ with trailing slash
        proxy_pass http://gateway_service/survey;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Dashboard routes - proxy to Gateway Service (which proxies to monolithic app)
    location /dashboard {
        proxy_pass http://gateway_service/dashboard;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
    
    location /dashboards {
        proxy_pass http://gateway_service/dashboards;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Kanban routes
    location /kanban/ {
        proxy_pass http://kanban_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Dashboard API routes - MUST come before /api/ location block
    # More specific location blocks must come before general ones
    # Match /api/dashboards and anything after it (like /api/dashboards/provinces)
    # Use ^~ modifier to prevent fallback to other location blocks
    # Match both with and without trailing slash
    location ^~ /api/dashboards {
        # CRITICAL: Enable access logging for this location to debug
        access_log logs/access.log;
        error_log logs/error.log debug;
        
        # Log request details
        add_header X-Debug-Location "api-dashboards" always;
        add_header X-Debug-Request-URI $request_uri always;
        add_header X-Debug-Upstream "gateway_service" always;
        
        proxy_pass http://gateway_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /api/dashboards;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Increase timeout for dashboard API requests
        proxy_read_timeout 120s;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        
        # Error handling
        proxy_intercept_errors off;
    }

    # API routes - general catch-all (must come after specific routes)
    # NOTE: /api/dashboards is handled above with ^~ modifier, so it won't match here
    location /api/ {
        # Route to appropriate service based on path
        if ($request_uri ~* "^/api/auth/") {
            proxy_pass http://auth_service;
        }
        if ($request_uri ~* "^/api/admin/") {
            proxy_pass http://admin_service;
        }
        if ($request_uri ~* "^/api/survey/") {
            proxy_pass http://survey_service;
        }
        if ($request_uri ~* "^/api/dashboard/") {
            proxy_pass http://dashboard_service;
        }
        if ($request_uri ~* "^/api/kanban/") {
            proxy_pass http://kanban_service;
        }
        
        # Default: proxy to gateway service for other /api/ routes
        proxy_pass http://gateway_service;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
    
    # Charts data route - proxy to gateway service (which proxies to monolithic app)
    location /charts-data {
        proxy_pass http://gateway_service/charts-data;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Login route - redirect to /auth/login
    location = /login {
        return 302 /auth/login$is_args$args;
    }

    # Static files - proxy to gateway service (which proxies to monolithic app)
    # This ensures static files work correctly
    location /static/ {
        proxy_pass http://gateway_service/static/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Cache static files
        proxy_cache_valid 200 1y;
        add_header Cache-Control "public, max-age=31536000";
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
    
    # Favicon
    location = /favicon.ico {
        alias C:/services/cert2/app/static/img/favicon.ico;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        access_log off;
    }

    # Default route to gateway service
    location / {
        proxy_pass http://gateway_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Proxy settings
        proxy_redirect off;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    }
}

