# راهنمای همگام‌سازی داده در پنل ادمین

## مقدمه

بخش همگام‌سازی داده در پنل ادمین امکان دریافت و به‌روزرسانی اطلاعات از API Gateway را فراهم می‌کند. این سیستم از فایل‌های موجود `faculty_main.py` و `students_main.py` استفاده می‌کند.

## منابع داده

### 1. اعضای هیئت علمی (Faculty)
- **فایل:** `app/fetch_data/faculty_main.py`
- **API Endpoint:** `https://api.cfu.ac.ir/API/Golestan/Faculty`
- **دیتابیس:** `app/fetch_data/faculty_data.db`
- **جدول:** `faculty`

### 2. دانشجویان (Students)
- **فایل:** `app/fetch_data/students_main.py`
- **API Endpoint:** `https://api.cfu.ac.ir/API/Golestan/Students_2`
- **دیتابیس:** `app/fetch_data/faculty_data.db`
- **جدول:** `Students`

## نحوه استفاده

### همگام‌سازی دستی

1. وارد پنل ادمین شوید: `/admin`
2. از منوی "همگام‌سازی داده" استفاده کنید
3. روی دکمه "همگام‌سازی" برای منبع داده مورد نظر کلیک کنید
4. یک پیام تأیید نمایش داده می‌شود
5. پس از تأیید، فرآیند همگام‌سازی شروع می‌شود

**نکته:** همگام‌سازی ممکن است چند دقیقه طول بکشد، به خصوص برای دانشجویان که باید برای تمام پردیس‌ها و ترم‌ها داده دریافت کند.

### تنظیم همگام‌سازی خودکار

1. روی دکمه "تنظیمات" برای منبع داده مورد نظر کلیک کنید
2. گزینه "همگام‌سازی خودکار فعال باشد" را فعال کنید
3. بازه زمانی همگام‌سازی را تنظیم کنید (به دقیقه)
4. تغییرات را ذخیره کنید

**نکته:** همگام‌سازی خودکار در حال حاضر نیاز به یک task scheduler خارجی دارد (مثل cron job یا Windows Task Scheduler). این قابلیت در نسخه‌های بعدی به صورت خودکار پیاده‌سازی خواهد شد.

## وضعیت همگام‌سازی

### وضعیت‌های ممکن:
- **pending:** در انتظار اجرا
- **running:** در حال اجرا
- **success:** موفقیت‌آمیز
- **failed:** ناموفق

### اطلاعات نمایش داده شده:
- **آخرین همگام‌سازی:** تاریخ و زمان آخرین همگام‌سازی (هجری شمسی)
- **مدت زمان:** مدت زمان اجرای همگام‌سازی (ثانیه)
- **تعداد رکوردها:** تعداد رکوردهای همگام‌سازی شده
- **خطاها:** در صورت بروز خطا، پیام خطا نمایش داده می‌شود

## جزئیات فنی

### نحوه کار

1. **Trigger همگام‌سازی:**
   - کاربر روی دکمه "همگام‌سازی" کلیک می‌کند
   - وضعیت sync به `running` تغییر می‌کند
   - فایل Python مربوطه (`faculty_main.py` یا `students_main.py`) به صورت subprocess اجرا می‌شود

2. **اجرای فایل:**
   - فایل در دایرکتوری `app/fetch_data` اجرا می‌شود
   - خروجی (stdout/stderr) capture می‌شود
   - Timeout: 1 ساعت برای faculty، 2 ساعت برای students

3. **به‌روزرسانی وضعیت:**
   - پس از اتمام، وضعیت به `success` یا `failed` تغییر می‌کند
   - تعداد رکوردها از خروجی parse می‌شود یا از دیتابیس خوانده می‌شود
   - مدت زمان اجرا ثبت می‌شود
   - در صورت خطا، پیام خطا ذخیره می‌شود

### محدودیت‌ها

1. **Blocking Execution:**
   - همگام‌سازی به صورت blocking اجرا می‌شود
   - برای production، بهتر است از task queue (مثل Celery) استفاده شود

2. **Timeout:**
   - Faculty: 1 ساعت
   - Students: 2 ساعت
   - در صورت timeout، وضعیت به `failed` تغییر می‌کند

3. **Error Handling:**
   - خطاها در فیلد `error_message` ذخیره می‌شوند
   - حداکثر طول پیام خطا: 500 کاراکتر

## عیب‌یابی

### همگام‌سازی ناموفق است

1. بررسی لاگ‌های سرور
2. بررسی فیلد `error_message` در جدول `data_syncs`
3. بررسی دسترسی به API Gateway
4. بررسی دسترسی به فایل‌های Python
5. بررسی دسترسی به دیتابیس

### تعداد رکوردها صفر است

1. بررسی خروجی فایل Python
2. بررسی دیتابیس برای وجود رکوردها
3. بررسی لاگ‌های فایل Python

### همگام‌سازی خیلی طول می‌کشد

1. بررسی تعداد پردیس‌ها و ترم‌ها (برای students)
2. بررسی سرعت API Gateway
3. بررسی timeout settings

## توسعه آینده

- [ ] پیاده‌سازی task queue (Celery) برای اجرای async
- [ ] اضافه کردن progress bar برای همگام‌سازی‌های طولانی
- [ ] اضافه کردن notification system
- [ ] اضافه کردن scheduled sync با استفاده از APScheduler
- [ ] اضافه کردن retry mechanism برای خطاها
- [ ] اضافه کردن partial sync (فقط داده‌های جدید)


