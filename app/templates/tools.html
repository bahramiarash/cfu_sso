<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ØµÙØ­Ù‡ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Your custom styles (including Vazir font) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            font-family: "Vazir", Tahoma, sans-serif; /* common Persian font fallback */
            background-color: #f8f9fa;
            padding: 0;
        }
        .navbar-custom {
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 0.5rem 0;
        }
        .navbar-brand-custom {
            color: #2c3e50 !important;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .navbar-brand-custom:hover {
            color: #1a252f !important;
        }
        .navbar-toggler {
            border-color: #dee2e6;
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%2844, 62, 80, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        .logout-btn {
            color: #2c3e50 !important;
            border-color: #dee2e6 !important;
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background-color: #f8f9fa !important;
            border-color: #adb5bd !important;
            color: #1a252f !important;
        }
        .main-content {
            padding: 2rem 1rem;
        }
        .tile-card {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .tile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .tile-card:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }
        .tile-icon {
            font-size: 3rem;
        }
        .welcome-message {
            color: #333;
        }
    </style>
</head>
<body>

<!-- University Header -->
<div class="university-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 0;">
    <div class="container">
        <div class="d-flex align-items-center justify-content-center gap-3 flex-wrap">
            <img src="{{ url_for('static', filename='img/university-logo.png') }}" 
                 alt="Ù„ÙˆÚ¯ÙˆÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ÙØ±Ù‡Ù†Ú¯ÛŒØ§Ù†" 
                 class="university-logo"
                 style="height: 60px; width: auto; object-fit: contain; display: block;"
                 onerror="this.style.display='none'">
            <h3 class="mb-0 text-center" style="font-weight: bold; font-size: 1.5rem; color: #2c3e50; background-color: rgba(255, 255, 255, 0.95); padding: 0.75rem 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: inline-block;">
                Ø³Ø§Ù…Ø§Ù†Ù‡ Ù¾Ø§ÛŒØ´ Ùˆ Ø±ØµØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ÙØ±Ù‡Ù†Ú¯ÛŒØ§Ù†
            </h3>
        </div>
    </div>
</div>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand navbar-brand-custom" href="{{ url_for('list_tools') }}">
            <i class="bi bi-house-door"></i> ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('dashboard.dashboard_list') }}" style="color: #2c3e50;">
                        <i class="bi bi-bar-chart"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯Ù‡Ø§
                    </a>
                </li>
            </ul>
            <div class="d-flex align-items-center gap-2">
                {% set nav_name = user_display_name if user_display_name else (user.get('firstname', '') + ' ' + user.get('lastname', '')).strip() if (user and (user.get('firstname') or user.get('lastname'))) else (user.get('name') if user else '') %}
                {% if nav_name and nav_name != 'Ú©Ø§Ø±Ø¨Ø± Ú¯Ø±Ø§Ù…ÛŒ' %}
                <span class="me-2" style="color: #2c3e50;">
                    <i class="bi bi-person-circle"></i>
                    {{ nav_name }}
                </span>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm logout-btn" aria-label="Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…">
                    <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="container main-content">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="mb-0 welcome-message flex-grow-1">
            Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ 
            {% if user_display_name %}
                {{ user_display_name }}
            {% elif user %}
                {% if user.get('firstname') or user.get('lastname') %}
                    {{ user.get('firstname', '') }} {{ user.get('lastname', '') }}
                {% elif user.get('name') %}
                    {{ user.get('name') }}
                {% elif user.get('preferred_username') %}
                    {{ user.get('preferred_username') }}
                {% elif user.get('username') %}
                    {{ user.get('username') }}
                {% else %}
                    Ú©Ø§Ø±Ø¨Ø± Ú¯Ø±Ø§Ù…ÛŒ
                {% endif %}
            {% else %}
                Ú©Ø§Ø±Ø¨Ø± Ú¯Ø±Ø§Ù…ÛŒ
            {% endif %}
        </h2>
    </div>

    <div class="row g-4">
        <!-- Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ - Ù‡Ù…ÛŒØ´Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
        <div class="col-12 col-sm-6 col-md-4">
            <a href="/survey" class="text-decoration-none text-dark" aria-label="Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ">
                <div class="card tile-card text-center p-4 h-100" role="button" tabindex="0">
                    <div class="tile-icon" aria-hidden="true">ğŸ“</div>
                    <h5 class="mt-3">Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ</h5>
                </div>
            </a>
        </div>
        
        <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø¦ÙˆÙ„ÛŒÙ† Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ -->
        {% if is_survey_manager %}
        <div class="col-12 col-sm-6 col-md-4">
            <a href="{{ url_for('survey.manager_dashboard') }}" class="text-decoration-none text-dark" aria-label="Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ">
                <div class="card tile-card text-center p-4 h-100 border-primary" role="button" tabindex="0" style="border-width: 2px;">
                    <div class="tile-icon" aria-hidden="true">âš™ï¸</div>
                    <h5 class="mt-3">Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ</h5>
                    <small class="text-muted">Ù¾Ù†Ù„ Ù…Ø³Ø¦ÙˆÙ„ÛŒÙ†</small>
                </div>
            </a>
        </div>
        {% endif %}

        <!-- Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± - ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø§Ø´ØªÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
        {% if has_dashboard_access %}
        <div class="col-12 col-sm-6 col-md-4">
            <a href="{{ url_for('dashboard.dashboard_list') }}" class="text-decoration-none text-dark" aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯Ù‡Ø§">
                <div class="card tile-card text-center p-4 h-100" role="button" tabindex="0">
                    <div class="tile-icon" aria-hidden="true">ğŸ“Š</div>
                    <h5 class="mt-3">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯Ù‡Ø§</h5>
                </div>
            </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4">
            <a href="http://bi.cfu.ac.ir:8080/dashboard" class="text-decoration-none text-dark" aria-label="Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØªØµÙ…ÛŒÙ… ÛŒØ§Ø± Ù‡Ù…ØªØ§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„" target="_blank" rel="noopener noreferrer">
                <div class="card tile-card text-center p-4 h-100" role="button" tabindex="0">
                    <div class="tile-icon" aria-hidden="true">ğŸ§‘â€ğŸ’»</div>
                    <h5 class="mt-3">ØªØµÙ…ÛŒÙ… ÛŒØ§Ø±</h5>
                    <h6>Ù‡Ù…ØªØ§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</h6>
                </div>
            </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4">
            <a href="/reports/" class="text-decoration-none text-dark" aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§">
                <div class="card tile-card text-center p-4 h-100" role="button" tabindex="0">
                    <div class="tile-icon" aria-hidden="true">ğŸ“ˆ</div>
                    <h5 class="mt-3">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h5>
                </div>
            </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4">
            <a href="/projects" class="text-decoration-none text-dark" aria-label="Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¸Ø§ÛŒÙ Ùˆ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§">
                <div class="card tile-card text-center p-4 h-100" role="button" tabindex="0">
                    <div class="tile-icon" aria-hidden="true">âœ…</div>
                    <h5 class="mt-3">Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¸Ø§ÛŒÙ</h5>
                </div>
            </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4">
            <a href="/digitaltwins/" class="text-decoration-none text-dark" aria-label="Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ùˆ Ù‡Ù…ØªØ§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„">
                <div class="card tile-card text-center p-4 h-100" role="button" tabindex="0">
                    <div class="tile-icon" aria-hidden="true">â˜ï¸</div>
                    <h5 class="mt-3">Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ</h5>
                </div>
            </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4">
            <a href="/calendar" class="text-decoration-none text-dark" aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙ‚ÙˆÛŒÙ…">
                <div class="card tile-card text-center p-4 h-100" role="button" tabindex="0">
                    <div class="tile-icon" aria-hidden="true">ğŸ“…</div>
                    <h5 class="mt-3">ØªÙ‚ÙˆÛŒÙ…</h5>
                </div>
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Prevent back button access after logout
// This ensures that if user logs out and tries to go back, they are redirected to login
(function() {
    var loginUrl = '{{ url_for("login") }}';
    
    // Replace current history entry to prevent back navigation to cached page
    if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', window.location.href);
    }
    
    // Listen for popstate event (back/forward button)
    window.addEventListener('popstate', function(event) {
        // Always redirect to login when back button is pressed
        // This prevents access to cached page after logout
        window.location.replace(loginUrl);
    });
    
    // Additional protection: Check on page load if coming from back button
    // This handles cases where browser might cache the page
    window.addEventListener('pageshow', function(event) {
        // If page was loaded from cache (back/forward button)
        if (event.persisted) {
            // Force redirect to login to check authentication
            window.location.replace(loginUrl);
        }
    });
    
    // Add meta tags to prevent caching
    if (document.querySelector('meta[http-equiv="Cache-Control"]') === null) {
        var metaCache = document.createElement('meta');
        metaCache.httpEquiv = 'Cache-Control';
        metaCache.content = 'no-store, no-cache, must-revalidate, max-age=0';
        document.getElementsByTagName('head')[0].appendChild(metaCache);
        
        var metaPragma = document.createElement('meta');
        metaPragma.httpEquiv = 'Pragma';
        metaPragma.content = 'no-cache';
        document.getElementsByTagName('head')[0].appendChild(metaPragma);
        
        var metaExpires = document.createElement('meta');
        metaExpires.httpEquiv = 'Expires';
        metaExpires.content = '0';
        document.getElementsByTagName('head')[0].appendChild(metaExpires);
    }
})();
</script>

</body>
</html>
