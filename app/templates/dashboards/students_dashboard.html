{% extends "dashboard_base.html" %}

{% block title %}{{ dashboard_title|default('آمار دانشجو معلمان') }}{% endblock %}

{% block content %}
<style>
  .gender-charts-container {
    display: flex;
    flex-direction: row;
  }
  
  .chart-container {
    max-width: 300px;
    margin: 0 auto;
  }
  
  .province-vazeiyat-container {
    height: 2000px;
  }
</style>

<div class="container">
  <!-- Gender Distribution -->
  <div class="card mb-4">
    <div class="card-body gender-charts-container">
      <div class="card-body">
        <h5 class="card-title">توزیع جنسیت از 1400 تا 1404</h5>
        <div class="chart-container">
          <canvas id="genderChart" width="300" height="300"></canvas>
        </div>
      </div>
      <div class="card-body">
        <h5 class="card-title">توزیع جنسیت 1404</h5>
        <div class="chart-container">
          <canvas id="genderChart404" width="300" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Students by Vazeiyat -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع وضعیت دانشجو معلمان</h5>
      <canvas id="vazeiyatChart"></canvas>
    </div>
  </div>

  <!-- Students by Vazeiyat 1404 -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع وضعیت دانشجو معلمان ورودی 1404</h5>
      <canvas id="vazeiyatChart_404"></canvas>
    </div>
  </div>

  <!-- Students by Province and Vazeiyat -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع وضعیت دانشجو معلمان بر اساس استان</h5>
      <div class="province-vazeiyat-container">
        <canvas id="provinceVazeiyatHorizontalChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Students by Course Kardani -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع رشته تحصیلی از 1400 تا 1404 مقطع کاردانی</h5>
      <canvas id="courseChartKardani"></canvas>
    </div>
  </div>

  <!-- Students by Course Karshenasi Peyvaste -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع رشته تحصیلی از 1400 تا 1404 مقطع کارشناسی پیوسته</h5>
      <canvas id="courseChartPeyvaste"></canvas>
    </div>
  </div>

  <!-- Students by Course Karshenasi Napeyvaste -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع رشته تحصیلی از 1400 تا 1404 کارشناسی ناپیوسته</h5>
      <canvas id="courseChartNapeyvaste"></canvas>
    </div>
  </div>

  <!-- Students by Course Karshenasi Arshad -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع رشته تحصیلی از 1400 تا 1404 کارشناسی ارشد</h5>
      <canvas id="courseChartArshad"></canvas>
    </div>
  </div>

  <!-- Students by Grade -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع مقطع تحصیلی از 1400 تا 1404</h5>
      <canvas id="gradeChart"></canvas>
    </div>
  </div>

  <!-- Students by Province -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع استانی دانشجومعلمان</h5>
      <canvas id="provinceChart1"></canvas>
    </div>
  </div>

  <!-- Students by Province and Year -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع استانی و سال ورود دانشجو معلمان</h5>
      <canvas id="provinceYearChart1"></canvas>
    </div>
  </div>

  <!-- Students by Province and Sex -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع استانی و جنسیت دانشجو معلمان</h5>
      <canvas id="provinceSexChart1"></canvas>
    </div>
  </div>

  <!-- Students by Entry Year Grade -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع ورودی‌ها در سال بر اساس مقطع</h5>
      <canvas id="entryYearChartGrade"></canvas>
    </div>
  </div>

  <!-- Students by Entry Year -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع ورودی‌ها در سال بر اساس جنسیت</h5>
      <canvas id="entryYearChart"></canvas>
    </div>
  </div>

  <!-- Students by Entrance Year and Course Kardani -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع دانشجومعلمان بر اساس سال ورود و رشته تحصیلی مقطع کاردانی</h5>
      <canvas id="scrollableCourseYearChartKardani" height="900" width="1800"></canvas>
    </div>
  </div>

  <!-- Students by Entrance Year and Course Karshenasi Napeyvaste -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع دانشجومعلمان بر اساس سال ورود و رشته تحصیلی مقطع کارشناسی ناپیوسته</h5>
      <canvas id="scrollableCourseYearChartKarshenasiNapeyvaste" height="900" width="1800"></canvas>
    </div>
  </div>

  <!-- Students by Entrance Year and Course Karshenasi Peyvaste -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع دانشجومعلمان بر اساس سال ورود و رشته تحصیلی مقطع کارشناسی پیوسته</h5>
      <canvas id="scrollableCourseYearChartKarshenasiPeyvaste" height="900" width="1800"></canvas>
    </div>
  </div>

  <!-- Students by Entrance Year and Course Arshad -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">توزیع دانشجومعلمان بر اساس سال ورود و رشته تحصیلی مقطع کارشناسی ارشد</h5>
      <canvas id="scrollableCourseYearChartArshad" height="900" width="1800"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js Integration -->
<script>
(function() {
  'use strict';

  // Wait for Chart.js to be fully loaded
  function waitForChart(callback) {
    if (typeof Chart !== 'undefined') {
      callback();
    } else {
      console.error('Chart.js is not loaded! Waiting...');
      setTimeout(() => waitForChart(callback), 100);
    }
  }

  waitForChart(function() {
    // Parse JSON data from backend
    const genderData = {{ gender_data | safe }};
    const genderData404 = {{ gender_data_404 | safe }};
    const courseDataKardani = {{ course_data_kardani | safe }};
    const courseDataNapeyvaste = {{ course_data_napeyvaste | safe }};
    const courseDataPeyvaste = {{ course_data_peyvaste | safe }};
    const courseDataArshad = {{ course_data_arshad | safe }};
    const gradeData = {{ grade_data | safe }};
    const provinceData1 = {{ province_data | safe }};
    const provinceYearData1 = {{ province_year_data | safe }};
    const provinceSexData1 = {{ province_sex_data | safe }};
    const yearData = {{ year_data | safe }};
    const yearDataGrade = {{ year_data_grade | safe }};
    const courseYearDataKardani = {{ course_year_data_kardani | safe }};
    const courseYearDataKarshenasiNapeyvaste = {{ course_year_data_karshenasi_napeyvaste | safe }};
    const courseYearDataKarshenasiPeyvaste = {{ course_year_data_karshenasi_peyvaste | safe }};
    const courseYearDataArshad = {{ course_year_data_arshad | safe }};
    const vazeiyatData = {{ vazeiyat_data | safe }};
    const vazeiyatData404 = {{ vazeiyat_data_404 | safe }};
    const provinceVazeiyatData = {{ province_vazeiyat_data | safe }};

    // Helper function to add export buttons
    function addExportButton(chartId, chartInstance, filename) {
      setTimeout(() => {
        if (typeof window.addChartExportButtons === 'function') {
          window.addChartExportButtons(chartId, chartInstance, filename);
        }
      }, 200);
    }

    // Helper function to generate random color
    function getRandomColor() {
      const r = Math.floor(Math.random() * 200);
      const g = Math.floor(Math.random() * 200);
      const b = Math.floor(Math.random() * 200);
      return `rgba(${r}, ${g}, ${b}, 0.6)`;
    }

    // Common data label configuration for horizontal bar charts
    const horizontalBarDataLabels = {
      display: true,
      anchor: 'end',
      align: 'end',
      clamp: true,
      offset: 15,
      color: '#000',
      rotation: 0,
      font: {
        family: 'Vazir',
        size: 14,
        weight: 'bold'
      },
      formatter: (value) => value
    };

    // Common data label configuration for vertical bar charts
    const verticalBarDataLabels = {
      display: true,
      anchor: 'end',
      align: 'center',
      offset: 0,
      color: '#000',
      rotation: 0,
      font: {
        family: 'Vazir',
        size: 14,
        weight: 'bold'
      },
      formatter: (value) => value
    };

    // Common data label configuration for pie/doughnut charts
    const pieDataLabels = {
      display: true,
      color: '#fff',
      font: {
        family: 'Vazir',
        size: 12,
        weight: 'bold'
      },
      formatter: (value) => value
    };

    // Common data label configuration for line charts
    const lineDataLabels = {
      display: true,
      anchor: 'end',
      align: 'top',
      offset: 5,
      color: '#000',
      font: {
        family: 'Vazir',
        size: 12,
        weight: 'bold'
      },
      formatter: (value) => value
    };

    // Common data label configuration for bar charts
    const barDataLabels = {
      display: true,
      anchor: 'end',
      align: 'top',
      offset: 5,
      color: '#000',
      font: {
        family: 'Vazir',
        size: 12,
        weight: 'bold'
      },
      formatter: (value) => value
    };

 
    function createAreaChart(canvasId, labels, data, colors, options = {}) {
      const defaultColors = [
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 99, 132, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)'
      ];
      
      const chartColors = colors || defaultColors;
      const datasets = Array.isArray(data[0]) ? data : [data];
      
      const config = {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets.map((dataset, index) => ({
            label: dataset.label || (Array.isArray(dataset) ? `Dataset ${index + 1}` : dataset.label),
            data: Array.isArray(dataset) ? dataset : (dataset.data || dataset),
            borderColor: chartColors[index % chartColors.length].replace('0.6', '1'),
            backgroundColor: chartColors[index % chartColors.length],
            fill: true, // This makes it an area chart
            tension: options.tension || 0.4,
            pointBackgroundColor: chartColors[index % chartColors.length].replace('0.6', '1'),
            pointBorderColor: '#fff',
            pointBorderWidth: options.pointBorderWidth || 2,
            pointRadius: options.pointRadius || 5,
            pointHoverRadius: options.pointHoverRadius || 7,
            ...options.datasetOptions
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: options.maintainAspectRatio !== false,
          plugins: {
            legend: {
              display: options.showLegend !== false,
              position: options.legendPosition || 'top'
            },
            datalabels: options.showDataLabels !== false ? lineDataLabels : { display: false },
            tooltip: {
              mode: 'index',
              intersect: false
            },
            ...options.plugins
          },
          scales: {
            x: {
              title: {
                display: options.xTitle ? true : false,
                text: options.xTitle || ''
              },
              ticks: {
                font: { family: 'Vazir' }
              }
            },
            y: {
              beginAtZero: options.beginAtZero !== false,
              title: {
                display: options.yTitle ? true : false,
                text: options.yTitle || ''
              },
              ticks: {
                font: { family: 'Vazir' }
              }
            }
          },
          ...options.chartOptions
        },
        plugins: [ChartDataLabels]
      };
      
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        console.error(`Canvas element with id "${canvasId}" not found`);
        return null;
      }
      
      const chart = new Chart(canvas, config);
      
      // Add export button if needed
      if (options.exportFilename) {
        addExportButton(canvasId, chart, options.exportFilename);
      }
      
      return chart;
    }


    // Gender Chart
    if (genderData && genderData.labels && genderData.counts) {
      const genderChart = new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
          labels: genderData.labels,
          datasets: [{
            data: genderData.counts,
            backgroundColor: ['rgba(255, 0, 0, 0.6)', 'rgba(0, 255, 0, 0.6)', 'rgba(0, 0, 255, 0.6)', 'rgba(255, 255, 0, 0.6)', 'rgba(255, 0, 255, 0.6)', 'rgba(0, 255, 255, 0.6)', 'rgba(255, 128, 0, 0.6)']
          }]
        }
      });
      addExportButton('genderChart', genderChart, 'توزیع_جنسیت_از_1400_تا_1404');
    } else {
      console.error('genderData is missing or invalid:', genderData);
    }

    // Gender Chart 404
    if (genderData404 && genderData404.labels && genderData404.counts) {
      const genderChart404 = new Chart(document.getElementById('genderChart404'), {
        type: 'doughnut',
        data: {
          labels: genderData404.labels,
          datasets: [{
            data: genderData404.counts,
            backgroundColor: ['rgba(0, 119, 190, 0.6)', 'rgba(0, 150, 255, 0.6)', 'rgba(64, 224, 208, 0.6)', 'rgba(0, 206, 209, 0.6)', 'rgba(72, 209, 204, 0.6)', 'rgba(95, 158, 160, 0.6)', 'rgba(176, 196, 222, 0.6)']
          }]
        }
      });
      addExportButton('genderChart404', genderChart404, 'توزیع_جنسیت_1404');
    } else {
      console.error('genderData404 is missing or invalid:', genderData404);
    }

    // Course Chart Kardani
    if (courseDataKardani && courseDataKardani.labels && courseDataKardani.counts) {
      // Generate colors for pie chart
      const pieColors = courseDataKardani.labels.map(() => getRandomColor());
      const courseChartKardani = new Chart(document.getElementById('courseChartKardani'), {
        type: 'pie',
        data: {
          labels: courseDataKardani.labels,
          datasets: [{
            label: 'Students',
            data: courseDataKardani.counts,
            backgroundColor: pieColors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            datalabels: pieDataLabels
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('courseChartKardani', courseChartKardani, 'توزیع_رشته_تحصیلی_از_1400_تا_1404_مقطع_کاردانی');
    } else {
      console.error('courseDataKardani is missing or invalid:', courseDataKardani);
    }

    // Course Chart Peyvaste
    if (courseDataPeyvaste && courseDataPeyvaste.labels && courseDataPeyvaste.counts) {
      const courseChartPeyvaste = new Chart(document.getElementById('courseChartPeyvaste'), {
        type: 'bar',
        data: {
          labels: courseDataPeyvaste.labels,
          datasets: [{
            label: 'Students',
            data: courseDataPeyvaste.counts,
            backgroundColor: '#4BC0C0'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: true },
            datalabels: horizontalBarDataLabels
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('courseChartPeyvaste', courseChartPeyvaste, 'توزیع_رشته_تحصیلی_از_1400_تا_1404_مقطع_کارشناسی_پیوسته');
    } else {
      console.error('courseDataPeyvaste is missing or invalid:', courseDataPeyvaste);
    }

    // Course Chart Napeyvaste
    if (courseDataNapeyvaste && courseDataNapeyvaste.labels && courseDataNapeyvaste.counts) {
      const courseChartNapeyvaste = new Chart(document.getElementById('courseChartNapeyvaste'), {
        type: 'bar',
        data: {
          labels: courseDataNapeyvaste.labels,
          datasets: [{
            label: 'Students',
            data: courseDataNapeyvaste.counts,
            backgroundColor: '#4BC0C0'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: true },
            datalabels: horizontalBarDataLabels
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('courseChartNapeyvaste', courseChartNapeyvaste, 'توزیع_رشته_تحصیلی_از_1400_تا_1404_کارشناسی_ناپیوسته');
    } else {
      console.error('courseDataNapeyvaste is missing or invalid:', courseDataNapeyvaste);
    }

    // Course Chart Arshad
    if (courseDataArshad && courseDataArshad.labels && courseDataArshad.counts) {
      const courseChartArshad = new Chart(document.getElementById('courseChartArshad'), {
        type: 'bar',
        data: {
          labels: courseDataArshad.labels,
          datasets: [{
            label: 'Students',
            data: courseDataArshad.counts,
            backgroundColor: '#4BC0C0'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: true },
            datalabels: horizontalBarDataLabels
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('courseChartArshad', courseChartArshad, 'توزیع_رشته_تحصیلی_از_1400_تا_1404_کارشناسی_ارشد');
    } else {
      console.error('courseDataArshad is missing or invalid:', courseDataArshad);
    }

    // Grade Chart
    if (gradeData && gradeData.labels && gradeData.counts) {
      const gradeChart = new Chart(document.getElementById('gradeChart'), {
        type: 'bar',
        data: {
          labels: gradeData.labels,
          datasets: [{
            label: 'Students',
            data: gradeData.counts,
            backgroundColor: '#9966FF'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            datalabels: verticalBarDataLabels
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'تعداد',
                font: { family: 'Vazir' }
              }
            },
            x: {
              ticks: {
                font: { family: 'Vazir' }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('gradeChart', gradeChart, 'توزیع_مقطع_تحصیلی_از_1400_تا_1404');
    } else {
      console.error('gradeData is missing or invalid:', gradeData);
    }

    // Province Chart
    if (provinceData1 && provinceData1.labels && provinceData1.counts) {
      const provinceChart1 = new Chart(document.getElementById('provinceChart1'), {
        type: 'bar',
        data: {
          labels: provinceData1.labels,
          datasets: [{
            label: 'استان ها',
            data: provinceData1.counts,
            backgroundColor: '#9966FF'
          }]
        },
        options: {
          plugins: {
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'start',
              offset: -33,
              color: '#000',
              font: {
                size: 14,
                weight: 'bold'
              },
              rotation: -90,
              formatter: (value) => value
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('provinceChart1', provinceChart1, 'توزیع_استانی_دانشجومعلمان');
    } else {
      console.error('provinceData1 is missing or invalid:', provinceData1);
    }

    // Province Year Chart
    if (provinceYearData1 && provinceYearData1.labels && provinceYearData1.years && provinceYearData1.data) {
      const colors = ['#9966FF', '#FF9933', '#33CC99', '#FF6666'];
      const datasets = provinceYearData1.years.map((year, idx) => ({
        label: `ورودی ${year}`,
        data: provinceYearData1.data[year],
        backgroundColor: colors[idx % colors.length]
      }));

      const provinceYearChart1 = new Chart(document.getElementById('provinceYearChart1'), {
        type: 'bar',
        data: {
          labels: provinceYearData1.labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'start',
              offset: -10,
              color: '#000',
              font: {
                size: 9,
                weight: 'normal'
              },
              rotation: -90,
              formatter: (value) => value
            },
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              stacked: false
            },
            y: {
              beginAtZero: true
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('provinceYearChart1', provinceYearChart1, 'توزیع_استانی_و_سال_ورود_دانشجو_معلمان');
    } else {
      console.error('provinceYearData1 is missing or invalid:', provinceYearData1);
    }

    // Province Sex Chart
    if (provinceSexData1 && provinceSexData1.labels && provinceSexData1.sex_list && provinceSexData1.data) {
      const colorsSex = ['#9966FF', '#FF9933'];
      const datasetsSex = provinceSexData1.sex_list.map((sex, idx) => ({
        label: `${sex}`,
        data: provinceSexData1.data[sex],
        backgroundColor: colorsSex[idx % colorsSex.length]
      }));

      const provinceSexChart1 = new Chart(document.getElementById('provinceSexChart1'), {
        type: 'bar',
        data: {
          labels: provinceSexData1.labels,
          datasets: datasetsSex
        },
        options: {
          responsive: true,
          plugins: {
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'start',
              offset: -10,
              color: '#000',
              font: {
                size: 9,
                weight: 'normal'
              },
              rotation: -90,
              formatter: (value) => value
            },
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              stacked: false
            },
            y: {
              beginAtZero: true
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('provinceSexChart1', provinceSexChart1, 'توزیع_استانی_و_جنسیت_دانشجو_معلمان');
    } else {
      console.error('provinceSexData1 is missing or invalid:', provinceSexData1);
    }

    // Entry Year Chart
    if (yearData && yearData.labels && yearData.total) {
      const entryYearChart = new Chart(document.getElementById('entryYearChart'), {
        type: 'bar',
        data: {
          labels: yearData.labels,
          datasets: [
            {
              label: 'کل',
              data: yearData.total,
              backgroundColor: '#4BC0C0'
            },
            {
              label: 'آقا',
              data: yearData.male,
              backgroundColor: '#36A2EB'
            },
            {
              label: 'خانم',
              data: yearData.female,
              backgroundColor: '#FF6384'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true }
          }
        }
, fill: true      });
      addExportButton('entryYearChart', entryYearChart, 'توزیع_ورودی_ها_در_سال_بر_اساس_جنسیت');
    } else {
      console.error('yearData is missing or invalid:', yearData);
    }

    // Entry Year Grade Chart
    if (yearDataGrade && yearDataGrade.labels) {
      const entryYearChartGrade = new Chart(document.getElementById('entryYearChartGrade'), {
        type: 'bar',
        data: {
          labels: yearDataGrade.labels,
          datasets: [
            {
              label: 'کاردانی',
              data: yearDataGrade.kardani,
              backgroundColor: '#347433'
            },
            {
              label: 'کارشناسی پیوسته',
              data: yearDataGrade.peyvaste,
              backgroundColor: '#FFC107'
            },
            {
              label: 'کارشناسی ناپیوسته',
              data: yearDataGrade.napeyvaste,
              backgroundColor: '#FF6F3C'
            },
            {
              label: 'کارشناسی ارشد',
              data: yearDataGrade.arshad,
              backgroundColor: '#B22222'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true }
          }
        }
      });
      addExportButton('entryYearChartGrade', entryYearChartGrade, 'توزیع_ورودی_ها_در_سال_بر_اساس_مقطع');
    } else {
      console.error('yearDataGrade is missing or invalid:', yearDataGrade);
    }

    // Helper function to create scrollable chart
    function createScrollableChart(canvasId, data, chartName) {
      if (!data || !data.labels || !data.datasets) {
        console.error(`${chartName} is missing or invalid:`, data);
        return;
      }

      const ctx = document.getElementById(canvasId).getContext('2d');
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: data.datasets.map(ds => ({
            label: ds.label,
            data: ds.data,
            backgroundColor: getRandomColor(),
            borderWidth: 1
          }))
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                autoSkip: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          },
          layout: {
            padding: 20
          }
        }
      });
      addExportButton(canvasId, chart, chartName);
    }

    // Scrollable Course Year Charts
    createScrollableChart('scrollableCourseYearChartKardani', courseYearDataKardani, 'توزیع_دانشجومعلمان_بر_اساس_سال_ورود_و_رشته_تحصیلی_مقطع_کاردانی');
    createScrollableChart('scrollableCourseYearChartKarshenasiNapeyvaste', courseYearDataKarshenasiNapeyvaste, 'توزیع_دانشجومعلمان_بر_اساس_سال_ورود_و_رشته_تحصیلی_مقطع_کارشناسی_ناپیوسته');
    createScrollableChart('scrollableCourseYearChartKarshenasiPeyvaste', courseYearDataKarshenasiPeyvaste, 'توزیع_دانشجومعلمان_بر_اساس_سال_ورود_و_رشته_تحصیلی_مقطع_کارشناسی_پیوسته');
    createScrollableChart('scrollableCourseYearChartArshad', courseYearDataArshad, 'توزیع_دانشجومعلمان_بر_اساس_سال_ورود_و_رشته_تحصیلی_مقطع_کارشناسی_ارشد');

    // Vazeiyat Chart
    if (vazeiyatData && vazeiyatData.labels && vazeiyatData.counts) {
      const vazeiyatChart = new Chart(document.getElementById('vazeiyatChart'), {
        type: 'bar',
        data: {
          labels: vazeiyatData.labels,
          datasets: [{
            label: 'تعداد دانشجویان',
            data: vazeiyatData.counts,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.8)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            datalabels: barDataLabels,
            title: {
              display: true,
              text: 'توزیع وضعیت دانشجو معلمان',
              font: { size: 18, family: 'Vazir' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'تعداد',
                font: { family: 'Vazir' }
              }
            },
            x: {
              ticks: {
                font: { family: 'Vazir' }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('vazeiyatChart', vazeiyatChart, 'توزیع_وضعیت_دانشجو_معلمان');
    } else {
      console.error('vazeiyatData is missing or invalid:', vazeiyatData);
    }

    // Vazeiyat Chart 404
    if (vazeiyatData404 && vazeiyatData404.labels && vazeiyatData404.counts) {
      const vazeiyatChart404 = new Chart(document.getElementById('vazeiyatChart_404'), {
        type: 'line',
        data: {
          labels: vazeiyatData404.labels,
          datasets: [{
            label: 'تعداد دانشجویان',
            data: vazeiyatData404.counts,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.8)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            datalabels: barDataLabels,
            title: {
              display: true,
              text: 'توزیع وضعیت دانشجو معلمان',
              font: { size: 18, family: 'Vazir' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'تعداد',
                font: { family: 'Vazir' }
              }
            },
            x: {
              ticks: {
                font: { family: 'Vazir' }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('vazeiyatChart_404', vazeiyatChart404, 'توزیع_وضعیت_دانشجو_معلمان_ورودی_1404');
    } else {
      console.error('vazeiyatData404 is missing or invalid:', vazeiyatData404);
    }

    // Province Vazeiyat Horizontal Chart
    if (provinceVazeiyatData && provinceVazeiyatData.labels && provinceVazeiyatData.datasets) {
      const provinceVazeiyatHorizontalChart = new Chart(document.getElementById('provinceVazeiyatHorizontalChart'), {
        type: 'bar',
        data: provinceVazeiyatData,
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: t, fill: true, fill: truerue,
              title: {
                display: true,
                text: 'تعداد دانشجو معلمان',
                font: { family: 'Vazir', size: 14 }
              },
              ticks: {
                font: { family: 'Vazir' }
              }
            },
            y: {
              stacked: true,
              title: {
                display: true,
                text: 'استان',
                font: { family: 'Vazir', size: 14 }
              },
              ticks: {
                autoSkip: false,
                font: { family: 'Vazir', size: 12 }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                boxWidth: 15,
                font: { family: 'Vazir', size: 11 }
              }
            },
            title: {
              display: true,
              text: 'توزیع وضعیت دانشجو معلمان بر اساس استان',
              font: { family: 'Vazir', size: 18 }
            },
            datalabels: {
              display: true
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const val = context.parsed.x || 0;
                  return `${context.dataset.label}: ${val.toLocaleString('fa-IR')}`;
                }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      addExportButton('provinceVazeiyatHorizontalChart', provinceVazeiyatHorizontalChart, 'توزیع_وضعیت_دانشجو_معلمان_بر_اساس_استان');
    } else {
      console.error('provinceVazeiyatData is missing or invalid:', provinceVazeiyatData);
    }
  });
})();
</script>

{% endblock %}
