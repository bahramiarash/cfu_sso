<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نقشه توزیع جنسیتی اعضای هیئت علمی</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- ✅ Required for responsiveness -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
    <style>
        .province-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 200px;
            direction: rtl;
            text-align: right;
        }
        .province-tooltip table {
            color: white;
            margin: 0;
            width: 100%;
        }
        .province-tooltip th {
            padding: 4px 8px;
            text-align: right;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        .province-tooltip td {
            padding: 4px 8px;
            text-align: right;
        }
        .province-tooltip .tooltip-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h2 class="text-center mb-4">توزیع جنسیتی اعضای هیئت علمی به تفکیک استان</h2>
        <div class="card shadow mb-4">
            <div class="card-body text-center position-relative">
                <div id="map-container" style="position: relative; display: inline-block; width: 100%;">
                    <img id="iran-map" src="data:image/png;base64,{{ image_data }}" style="width:100%; cursor: pointer;" usemap="#province-map">
                    <div id="province-tooltip" class="province-tooltip" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Table -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">جدول آمار اعضای هیئت علمی به تفکیک استان</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="statistics-table" class="table table-striped table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>ردیف</th>
                                <th>نام استان</th>
                                <th>تعداد کل</th>
                                <th>تعداد زن</th>
                                <th>تعداد مرد</th>
                                <th>درصد زن</th>
                                <th>درصد مرد</th>
                                <th>درصد از کل کشور</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ row.province_name }}</td>
                                <td>{{ "{:,}".format(row.total) }}</td>
                                <td>{{ "{:,}".format(row.female_count) }}</td>
                                <td>{{ "{:,}".format(row.male_count) }}</td>
                                <td>{{ "%.1f"|format(row.female_percent) }}%</td>
                                <td>{{ "%.1f"|format(row.male_percent) }}%</td>
                                <td>{{ "%.2f"|format(row.country_percent) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary fw-bold">
                            <tr>
                                <td colspan="2">جمع کل کشور</td>
                                <td>{{ "{:,}".format(total_country) }}</td>
                                <td>{{ "{:,}".format(table_data|sum(attribute='female_count')) }}</td>
                                <td>{{ "{:,}".format(table_data|sum(attribute='male_count')) }}</td>
                                <td>{{ "%.1f"|format((table_data|sum(attribute='female_count') / total_country * 100) if total_country > 0 else 0) }}%</td>
                                <td>{{ "%.1f"|format((table_data|sum(attribute='male_count') / total_country * 100) if total_country > 0 else 0) }}%</td>
                                <td>100.00%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Province data from backend
        var provinceData = {};
        {% for code, data in province_data_json.items() %}
        provinceData[{{ code }}] = {
            name: {{ data.name | tojson }},
            male: {{ data.male }},
            female: {{ data.female }},
            total: {{ data.total }},
            x: {{ data.x | default(0) }},
            y: {{ data.y | default(0) }}
        };
        {% endfor %}
        
        // Tooltip element
        const tooltip = document.getElementById('province-tooltip');
        const mapImage = document.getElementById('iran-map');
        const mapContainer = document.getElementById('map-container');
        
        function showTooltip(event, data, provinceName) {
            tooltip.innerHTML = '<div class="tooltip-title">' + provinceName + '</div>' +
                '<table>' +
                '<tr><th>جنسیت</th><th>تعداد</th></tr>' +
                '<tr><td>مرد</td><td>' + data.male.toLocaleString('fa-IR') + ' نفر</td></tr>' +
                '<tr><td>زن</td><td>' + data.female.toLocaleString('fa-IR') + ' نفر</td></tr>' +
                '<tr style="border-top: 1px solid rgba(255,255,255,0.3);">' +
                '<td><strong>جمع کل</strong></td>' +
                '<td><strong>' + data.total.toLocaleString('fa-IR') + ' نفر</strong></td>' +
                '</tr></table>';
            
            tooltip.style.display = 'block';
            
            // Position tooltip near mouse cursor
            const rect = mapContainer.getBoundingClientRect();
            let left = event.clientX - rect.left + 15;
            let top = event.clientY - rect.top - 10;
            
            // Keep tooltip within container bounds
            const tooltipRect = tooltip.getBoundingClientRect();
            if (left + tooltipRect.width > rect.width) {
                left = event.clientX - rect.left - tooltipRect.width - 15;
            }
            if (top + tooltipRect.height > rect.height) {
                top = event.clientY - rect.top - tooltipRect.height - 10;
            }
            if (top < 0) {
                top = 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
        
        function hideTooltip() {
            tooltip.style.display = 'none';
        }
        
        // Show tooltip when hovering over table rows
        document.querySelectorAll('#statistics-table tbody tr').forEach((row) => {
            row.addEventListener('mouseenter', function(e) {
                const provinceName = this.cells[1].textContent.trim();
                // Find province code from table data
                const provinceCode = Object.keys(provinceData).find(function(code) {
                    return provinceData[code].name === provinceName;
                });
                if (provinceCode && provinceData[provinceCode]) {
                    const rect = this.getBoundingClientRect();
                    const event = { clientX: rect.left + rect.width / 2, clientY: rect.top };
                    showTooltip(event, provinceData[provinceCode], provinceName);
                }
            });
            row.addEventListener('mouseleave', function() {
                hideTooltip();
            });
        });
        
        // Show tooltip when hovering over map
        // Find nearest province based on mouse position using centroid coordinates
        mapImage.addEventListener('mousemove', function(e) {
            var rect = mapImage.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            
            // Normalize coordinates (0-1)
            var relX = x / rect.width;
            var relY = y / rect.height;
            
            // Find nearest province centroid
            var nearestProvince = null;
            var minDistance = Infinity;
            
            for (var code in provinceData) {
                var prov = provinceData[code];
                if (prov.x !== undefined && prov.y !== undefined) {
                    var dx = relX - prov.x;
                    var dy = relY - prov.y;
                    var distance = Math.sqrt(dx * dx + dy * dy);
                    // Threshold for detection (15% of map size)
                    if (distance < minDistance && distance < 0.15) {
                        minDistance = distance;
                        nearestProvince = {code: code, data: prov};
                    }
                }
            }
            
            if (nearestProvince) {
                showTooltip(e, nearestProvince.data, nearestProvince.data.name);
            } else {
                hideTooltip();
            }
        });
        
        mapImage.addEventListener('mouseleave', function() {
            hideTooltip();
        });
    </script>
</body>
</html>
