{% extends "survey/manager/base.html" %}

{% block title %}گزارش‌های پرسشنامه{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-graph-up"></i> گزارش‌های پرسشنامه: {{ survey.title }}</h1>
        <div>
            <a href="{{ url_for('survey.manager_reports_export_excel', survey_id=survey.id, date_from=date_from or '', date_to=date_to or '') }}" 
               class="btn btn-success me-2">
                <i class="bi bi-file-earmark-excel"></i> خروجی Excel
            </a>
            <a href="{{ url_for('survey.manager_surveys_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-right"></i> بازگشت
            </a>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="date_from" class="form-label">از تاریخ (هجری شمسی)</label>
                    <input type="text" class="form-control" id="date_from" name="date_from" 
                           value="{{ date_from or '' }}" placeholder="1403/01/01" autocomplete="off">
                </div>
                <div class="col-md-4">
                    <label for="date_to" class="form-label">تا تاریخ (هجری شمسی)</label>
                    <input type="text" class="form-control" id="date_to" name="date_to" 
                           value="{{ date_to or '' }}" placeholder="1403/12/29" autocomplete="off">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">فیلتر</button>
                    <a href="{{ url_for('survey.manager_reports_overview', survey_id=survey.id) }}" class="btn btn-secondary">پاک کردن</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stat-card">
                <div class="card-body">
                    <h5 class="card-title">کل پاسخ‌ها</h5>
                    <h2 class="text-info">{{ total_responses }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card">
                <div class="card-body">
                    <h5 class="card-title">تکمیل شده</h5>
                    <h2 class="text-success">{{ completed_responses }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card">
                <div class="card-body">
                    <h5 class="card-title">شروع شده (ناتمام)</h5>
                    <h2 class="text-warning">{{ attempted_responses }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Completion Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="bi bi-bar-chart"></i> نمودار تعداد پرسشنامه تکمیل شده در هر روز</h5>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Participants Table -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-table"></i> جدول شرکت کنندگان</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <input type="text" class="form-control" id="participantsSearch" placeholder="جستجو در جدول...">
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="participantsTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0, 'participantsTable')">
                                شناسه پاسخ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(1, 'participantsTable')">
                                نام کاربر <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(2, 'participantsTable')">
                                کد ملی <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(3, 'participantsTable')">
                                تاریخ شروع <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(4, 'participantsTable')">
                                تاریخ تکمیل <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th>وضعیت</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for response in all_responses %}
                        <tr>
                            <td>{{ response.id }}</td>
                            <td>{{ response.user.name if response.user else 'نامشخص' }}</td>
                            <td>{{ response.national_id or 'نامشخص' }}</td>
                            <td>
                                {% if response.started_at %}
                                    {{ jdatetime.datetime.fromgregorian(datetime=response.started_at).strftime('%Y/%m/%d %H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if response.completed_at %}
                                    {{ jdatetime.datetime.fromgregorian(datetime=response.completed_at).strftime('%Y/%m/%d %H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if response.is_completed %}
                                    <span class="badge bg-success">تکمیل شده</span>
                                {% else %}
                                    <span class="badge bg-warning">شروع شده</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('survey.manager_reports_response_detail', survey_id=survey.id, response_id=response.id) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i> مشاهده پاسخ‌ها
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Question Statistics Charts -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="bi bi-bar-chart-fill"></i> نمودار تعداد پاسخ‌های هر سوال</h5>
        </div>
        <div class="card-body">
            {% if question_stats_by_category %}
                {% set question_index = [] %}
                {% for category_group in question_stats_by_category %}
                    <div class="mb-5">
                        <h4 class="mb-3" style="color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                            <i class="bi bi-folder-fill"></i> {{ category_group.category.title }}
                        </h4>
                        {% if category_group.category.description %}
                            <p class="text-muted mb-3">{{ category_group.category.description }}</p>
                        {% endif %}
                        {% for stat in category_group.questions %}
                            <div class="mb-4" style="margin-right: 20px;">
                                <h6 style="font-weight: 600; color: #495057;">{{ stat.question.question_text if stat.question else '' }}</h6>
                                <div class="question-chart-container">
                                    <canvas id="questionChart{{ question_index|length }}"></canvas>
                                </div>
                                {% set _ = question_index.append(1) %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-warning text-center">
                    داده‌ای برای نمایش نمودار پاسخ‌های سوالات یافت نشد.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Question Statistics Table -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-table"></i> جدول آمار پاسخ‌های هر سوال</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <input type="text" class="form-control" id="questionsSearch" placeholder="جستجو در جدول...">
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="questionsTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0, 'questionsTable')">
                                سوال <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(1, 'questionsTable')">
                                گزینه <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(2, 'questionsTable')">
                                تعداد پاسخ <i class="bi bi-arrow-down-up"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category_group in question_stats_by_category %}
                            {% for stat in category_group.questions %}
                                {% if stat.option_counts_ordered %}
                                    {% for item in stat.option_counts_ordered %}
                                    <tr>
                                        <td>{{ stat.question.question_text }}</td>
                                        <td>{{ item.option }}</td>
                                        <td>{{ item.count }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    {% for option, count in stat.option_counts.items() %}
                                    <tr>
                                        <td>{{ stat.question.question_text }}</td>
                                        <td>{{ option }}</td>
                                        <td>{{ count }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
// Initialize date pickers
(function() {
    function initDatePickers() {
        if (typeof kamaDatepicker !== 'undefined') {
            try {
                kamaDatepicker('date_from', {
                    forceFarsiDigits: true,
                    markToday: true,
                    markHolidays: true,
                    gotoToday: true,
                    highlightSelectedDay: true,
                    format: 'YYYY/MM/DD'
                });
                
                kamaDatepicker('date_to', {
                    forceFarsiDigits: true,
                    markToday: true,
                    markHolidays: true,
                    gotoToday: true,
                    highlightSelectedDay: true,
                    format: 'YYYY/MM/DD'
                });
            } catch (error) {
                console.error('Error initializing KamaDatepicker:', error);
                setTimeout(initDatePickers, 500);
            }
        } else {
            setTimeout(initDatePickers, 500);
        }
    }
    initDatePickers();
})();

// Daily completion chart
const dailyChartData = {{ daily_chart_data | tojson }};
const dailyChartCanvas = document.getElementById('dailyChart');
if (dailyChartCanvas && dailyChartData && dailyChartData.length > 0) {
    // Set fixed dimensions
    dailyChartCanvas.style.width = '100%';
    dailyChartCanvas.style.height = '400px';
    dailyChartCanvas.width = dailyChartCanvas.offsetWidth;
    dailyChartCanvas.height = 400;
    
    const ctx = dailyChartCanvas.getContext('2d');
    const dailyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dailyChartData.map(d => d.date),
            datasets: [{
                label: 'تعداد تکمیل شده',
                data: dailyChartData.map(d => d.count),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: undefined,
            layout: {
                padding: {
                    top: 10,
                    bottom: 10,
                    left: 10,
                    right: 10
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'تعداد: ' + context.parsed.y;
                        }
                    }
                }
            }
        }
    });
    
    // Force resize to maintain fixed height
    setTimeout(() => {
        dailyChart.resize();
    }, 100);
} else if (dailyChartCanvas) {
    // Show message if no data
    dailyChartCanvas.parentElement.innerHTML = '<p class="text-muted text-center p-4">داده‌ای برای نمایش وجود ندارد</p>';
}

// Question statistics charts
// Color mapping for consistent colors across all questions
const optionColorMap = {};
const colorPalette = [
    { bg: 'rgba(54, 162, 235, 0.6)', border: 'rgba(54, 162, 235, 1)' },  // Blue
    { bg: 'rgba(255, 99, 132, 0.6)', border: 'rgba(255, 99, 132, 1)' },  // Red
    { bg: 'rgba(75, 192, 192, 0.6)', border: 'rgba(75, 192, 192, 1)' },  // Teal
    { bg: 'rgba(255, 206, 86, 0.6)', border: 'rgba(255, 206, 86, 1)' },  // Yellow
    { bg: 'rgba(153, 102, 255, 0.6)', border: 'rgba(153, 102, 255, 1)' }, // Purple
    { bg: 'rgba(255, 159, 64, 0.6)', border: 'rgba(255, 159, 64, 1)' },  // Orange
    { bg: 'rgba(199, 199, 199, 0.6)', border: 'rgba(199, 199, 199, 1)' }, // Grey
    { bg: 'rgba(83, 102, 255, 0.6)', border: 'rgba(83, 102, 255, 1)' },  // Indigo
    { bg: 'rgba(255, 99, 255, 0.6)', border: 'rgba(255, 99, 255, 1)' },  // Pink
    { bg: 'rgba(99, 255, 132, 0.6)', border: 'rgba(99, 255, 132, 1)' }   // Green
];
let colorIndex = 0;

function getColorForOption(option) {
    if (!optionColorMap[option]) {
        optionColorMap[option] = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
    }
    return optionColorMap[option];
}

const questionStats = {{ question_stats_json | tojson }};
if (questionStats && questionStats.length > 0) {
    questionStats.forEach((stat, index) => {
        const canvasId = 'questionChart' + index;
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            // Set fixed dimensions
            canvas.style.width = '100%';
            canvas.style.height = '300px';
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            
            const ctx = canvas.getContext('2d');
            
            // Use ordered data to preserve creation order
            let labels = [];
            let data = [];
            let backgroundColors = [];
            let borderColors = [];
            
            if (stat.option_counts_ordered && stat.option_counts_ordered.length > 0) {
                // Use ordered list to preserve creation order
                stat.option_counts_ordered.forEach(item => {
                    labels.push(item.option);
                    data.push(item.count);
                    const color = getColorForOption(item.option);
                    backgroundColors.push(color.bg);
                    borderColors.push(color.border);
                });
            } else {
                // Fallback to unordered if ordered data not available
                labels = Object.keys(stat.option_counts);
                data = Object.values(stat.option_counts);
                labels.forEach(option => {
                    const color = getColorForOption(option);
                    backgroundColors.push(color.bg);
                    borderColors.push(color.border);
                });
            }
            
            const questionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'تعداد پاسخ',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: undefined,
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
            
            // Force resize to maintain fixed height
            setTimeout(() => {
                questionChart.resize();
            }, 100);
        }
    });
}

// Table sorting
let sortDirections = {};
function sortTable(columnIndex, tableId) {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const direction = sortDirections[tableId + columnIndex] || 'asc';
    sortDirections[tableId + columnIndex] = direction === 'asc' ? 'desc' : 'asc';
    
    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        
        // Try to parse as number
        const aNum = parseFloat(aText);
        const bNum = parseFloat(bText);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return direction === 'asc' ? aNum - bNum : bNum - aNum;
        }
        
        return direction === 'asc' 
            ? aText.localeCompare(bText, 'fa')
            : bText.localeCompare(aText, 'fa');
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

// Table search/filter
document.getElementById('participantsSearch').addEventListener('keyup', function() {
    filterTable('participantsTable', this.value);
});

document.getElementById('questionsSearch').addEventListener('keyup', function() {
    filterTable('questionsTable', this.value);
});

function filterTable(tableId, searchText) {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tbody tr');
    const searchLower = searchText.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchLower) ? '' : 'none';
    });
}
</script>

<style>
.stat-card {
    border-left: 4px solid #007bff;
}
.stat-card .card-title {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}
.stat-card h2 {
    font-size: 2rem;
    font-weight: bold;
    margin: 0;
}

/* Chart container styles - fixed height */
#dailyChart {
    max-height: 400px !important;
    height: 400px !important;
    width: 100% !important;
}

canvas[id^="questionChart"] {
    max-height: 300px !important;
    height: 300px !important;
    width: 100% !important;
}

/* Ensure chart containers maintain fixed height */
.chart-container {
    height: 400px;
    position: relative;
    width: 100%;
}

.question-chart-container {
    height: 300px;
    position: relative;
    width: 100%;
}
</style>
{% endblock %}
