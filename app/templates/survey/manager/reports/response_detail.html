{% if is_admin %}
{% extends "admin/base.html" %}
{% else %}
{% extends "survey/manager/base.html" %}
{% endif %}

{% block title %}جزئیات پاسخ: {{ survey.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-file-text"></i> جزئیات پاسخ پرسشنامه: {{ survey.title }}</h1>
        <div>
            {% if is_admin %}
            <a href="{{ url_for('admin.survey_surveys_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-right"></i> بازگشت
            </a>
            {% else %}
            <a href="{{ url_for('survey.manager_reports_overview', survey_id=survey.id) }}" class="btn btn-secondary">
                <i class="bi bi-arrow-right"></i> بازگشت به گزارشات
            </a>
            {% endif %}
        </div>
    </div>

    <!-- User Information -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="bi bi-person"></i> اطلاعات کاربر</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>نام کاربر:</strong> {{ user_display_name }}</p>
                    {% if user %}
                    <p><strong>ایمیل:</strong> {{ user.email or '-' }}</p>
                    {% endif %}
                    <p><strong>کد ملی:</strong> {{ response.national_id or '-' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>شناسه پاسخ:</strong> {{ response.id }}</p>
                    <p><strong>تاریخ شروع:</strong> 
                        {% if response.started_at %}
                            {{ jdatetime.datetime.fromgregorian(datetime=response.started_at).strftime('%Y/%m/%d %H:%M') }}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                    <p><strong>تاریخ تکمیل:</strong> 
                        {% if response.completed_at %}
                            {{ jdatetime.datetime.fromgregorian(datetime=response.completed_at).strftime('%Y/%m/%d %H:%M') }}
                        {% else %}
                            <span class="text-warning">تکمیل نشده</span>
                        {% endif %}
                    </p>
                    <p><strong>وضعیت:</strong> 
                        {% if response.is_completed %}
                            <span class="badge bg-success">تکمیل شده</span>
                        {% else %}
                            <span class="badge bg-warning">شروع شده</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- URL Parameters (for anonymous surveys) -->
    {% if survey.access_type == 'anonymous' and response_parameters %}
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="bi bi-link-45deg"></i> پارامترهای URL</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for param_name, param_value in response_parameters.items() %}
                <div class="col-md-6 mb-2">
                    <p><strong>{{ param_name }}:</strong> {{ param_value }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Questions and Answers -->
    <div class="card">
        <div class="card-header">
            <h5><i class="bi bi-question-circle"></i> سوالات و پاسخ‌ها</h5>
        </div>
        <div class="card-body">
            {% if categories %}
                {% for category in categories %}
                <div class="category-section mb-4">
                    <h5 class="text-primary border-bottom pb-2 mb-3">
                        <i class="bi bi-folder"></i> {{ category.title }}
                    </h5>
                    {% if category.description %}
                    <p class="text-muted mb-3">{{ category.description }}</p>
                    {% endif %}
                    
                    {% for question in questions_by_category.get(category.id, []) %}
                    <div class="question-answer-item mb-4 p-3 border rounded">
                        <div class="question-header mb-2">
                            <strong class="d-block mb-1">
                                سوال {{ loop.index }}:
                                {% if question.is_required %}
                                <span class="text-danger">*</span>
                                {% endif %}
                                {{ question.question_text }}
                            </strong>
                            {% if question.description %}
                            <small class="text-muted d-block">{{ question.description }}</small>
                            {% endif %}
                        </div>
                        
                        <div class="answer-content">
                            {% set answer = answers.get(question.id) %}
                            {% if answer %}
                                {% if question.question_type.startswith('likert_') %}
                                    {% set option_count = question.question_type.split('_')[1] | int %}
                                    {% set options = question.options if question.options else [] %}
                                    {% if options and options is mapping %}
                                        {% set options_list = options.get('options', []) %}
                                    {% elif options is iterable and options is not string %}
                                        {% set options_list = options %}
                                    {% else %}
                                        {% set options_list = [] %}
                                    {% endif %}
                                    <p class="mb-0">
                                        <strong>پاسخ:</strong> 
                                        {% if answer.answer_value is not none %}
                                            {% if options_list and answer.answer_value < options_list|length %}
                                                {{ options_list[answer.answer_value] }}
                                            {% else %}
                                                گزینه {{ answer.answer_value + 1 }}
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">پاسخی ثبت نشده</span>
                                        {% endif %}
                                    </p>
                                {% elif question.question_type == 'text' %}
                                    <p class="mb-0"><strong>پاسخ:</strong></p>
                                    <div class="p-3 bg-light border rounded mt-2">
                                        {{ answer.answer_text or '<span class="text-muted">پاسخی ثبت نشده</span>' | safe }}
                                    </div>
                                {% elif question.question_type == 'file_upload' %}
                                    <p class="mb-0"><strong>فایل ارسال شده:</strong></p>
                                    {% if answer.file_path %}
                                        <div class="mt-2">
                                            {% if answer.file_path %}
                                                {% if answer.file_path.startswith('/static/uploads/surveys/files/') %}
                                                    {% set filename = answer.file_path.replace('/static/uploads/surveys/files/', '') %}
                                                    {% set file_url = url_for('survey.survey_uploaded_file', filename=filename) %}
                                                {% elif answer.file_path.startswith('static/uploads/surveys/files/') %}
                                                    {% set filename = answer.file_path.replace('static/uploads/surveys/files/', '') %}
                                                    {% set file_url = url_for('survey.survey_uploaded_file', filename=filename) %}
                                                {% elif answer.file_path.startswith('http') %}
                                                    {% set file_url = answer.file_path %}
                                                {% else %}
                                                    {# Try to extract filename from path #}
                                                    {% set filename = answer.file_path.split('/')[-1] %}
                                                    {% set file_url = url_for('survey.survey_uploaded_file', filename=filename) %}
                                                {% endif %}
                                            {% endif %}
                                            <a href="{{ file_url }}" target="_blank" class="btn btn-sm btn-primary">
                                                <i class="bi bi-download"></i> دانلود فایل
                                            </a>
                                            {% if answer.file_path.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp')) %}
                                            <div class="mt-3">
                                                <img src="{{ file_url }}" alt="فایل ارسال شده" 
                                                     class="img-thumbnail" style="max-width: 100%; max-height: 400px;">
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">فایلی ارسال نشده</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span class="text-muted">پاسخی ثبت نشده</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% endif %}
            
            <!-- Questions without category -->
            {% if questions_without_category %}
            <div class="category-section mb-4">
                <h5 class="text-primary border-bottom pb-2 mb-3">سوالات بدون دسته‌بندی</h5>
                
                {% for question in questions_without_category %}
                <div class="question-answer-item mb-4 p-3 border rounded">
                    <div class="question-header mb-2">
                        <strong class="d-block mb-1">
                            سوال {{ loop.index }}:
                            {% if question.is_required %}
                            <span class="text-danger">*</span>
                            {% endif %}
                            {{ question.question_text }}
                        </strong>
                        {% if question.description %}
                        <small class="text-muted d-block">{{ question.description }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="answer-content">
                        {% set answer = answers.get(question.id) %}
                        {% if answer %}
                            {% if question.question_type.startswith('likert_') %}
                                {% set option_count = question.question_type.split('_')[1] | int %}
                                {% set options = question.options if question.options else [] %}
                                {% if options and options is mapping %}
                                    {% set options_list = options.get('options', []) %}
                                {% elif options is iterable and options is not string %}
                                    {% set options_list = options %}
                                {% else %}
                                    {% set options_list = [] %}
                                {% endif %}
                                <p class="mb-0">
                                    <strong>پاسخ:</strong> 
                                    {% if answer.answer_value is not none %}
                                        {% if options_list and answer.answer_value < options_list|length %}
                                            {{ options_list[answer.answer_value] }}
                                        {% else %}
                                            گزینه {{ answer.answer_value + 1 }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">پاسخی ثبت نشده</span>
                                    {% endif %}
                                </p>
                            {% elif question.question_type == 'text' %}
                                <p class="mb-0"><strong>پاسخ:</strong></p>
                                <div class="p-3 bg-light border rounded mt-2">
                                    {{ answer.answer_text or '<span class="text-muted">پاسخی ثبت نشده</span>' | safe }}
                                </div>
                            {% elif question.question_type == 'file_upload' %}
                                <p class="mb-0"><strong>فایل ارسال شده:</strong></p>
                                {% if answer.file_path %}
                                    <div class="mt-2">
                                        {% if answer.file_path %}
                                            {% if answer.file_path.startswith('/static/uploads/surveys/files/') %}
                                                {% set filename = answer.file_path.replace('/static/uploads/surveys/files/', '') %}
                                                {% set file_url = url_for('survey.survey_uploaded_file', filename=filename) %}
                                            {% elif answer.file_path.startswith('static/uploads/surveys/files/') %}
                                                {% set filename = answer.file_path.replace('static/uploads/surveys/files/', '') %}
                                                {% set file_url = url_for('survey.survey_uploaded_file', filename=filename) %}
                                            {% elif answer.file_path.startswith('http') %}
                                                {% set file_url = answer.file_path %}
                                            {% else %}
                                                {# Try to extract filename from path #}
                                                {% set filename = answer.file_path.split('/')[-1] %}
                                                {% set file_url = url_for('survey.survey_uploaded_file', filename=filename) %}
                                            {% endif %}
                                        {% endif %}
                                        <a href="{{ file_url }}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="bi bi-download"></i> دانلود فایل
                                        </a>
                                        {% if answer.file_path.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp')) %}
                                        <div class="mt-3">
                                            <img src="{{ file_url }}" alt="فایل ارسال شده" 
                                                 class="img-thumbnail" style="max-width: 100%; max-height: 400px;">
                                        </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">فایلی ارسال نشده</span>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <span class="text-muted">پاسخی ثبت نشده</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if not categories and not questions_without_category %}
            <p class="text-muted">هیچ سوالی در این پرسشنامه تعریف نشده است.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

